# Story 1.6: Minimal MCP Server Proof of Concept

## Status
ready for development

## Story
**As a** developer debugging connection issues,
**I want** the simplest possible MCP server implementation following the official SDK README example,
**so that** I can isolate whether the Cloudflare tunnel + Claude.ai integration works with a baseline implementation.

## Acceptance Criteria
1. Create a minimal MCP server using the exact pattern from the official Python SDK README (https://github.com/modelcontextprotocol/python-sdk/blob/main/README.md)
2. Server implements a single static tool called "hello" that returns a simple greeting message
3. Tool does not require parameters or perform any complex logic
4. Server runs on port 8080 to maintain Cloudflare tunnel configuration compatibility
5. Server can be started with `python -m src` command
6. Health endpoint (`/health`) available for tunnel validation
7. Server successfully connects to Claude.ai via existing Cloudflare tunnel
8. End-to-end test: Claude.ai can successfully call the "hello" tool and receive the static response
9. All code passes black, ruff, and mypy --strict checks
10. Basic unit tests for server initialization and tool registration (minimum viable testing)

## Tasks / Subtasks

- [x] Task 1 (AC: 1, 2, 3): Create minimal MCP server from SDK README example
  - [x] Create new file `src/minimal_mcp_server.py` (or backup existing mcp_server.py if needed)
  - [x] Copy the simplest working example from https://github.com/modelcontextprotocol/python-sdk/blob/main/README.md
  - [x] Implement single "hello" tool that returns static message: "Hello from minimal MCP server!"
  - [x] No tool parameters required
  - [x] No complex logic, no external dependencies (YouTube API, OAuth, etc.)
  - [x] Configure to use port 8080

- [x] Task 2 (AC: 4, 5): Configure server startup and port
  - [x] Modify `src/__main__.py` to launch minimal server on port 8080
  - [x] Ensure compatibility with existing `python -m src` entry point
  - [x] Add environment variable `USE_MINIMAL_SERVER=true` to switch between implementations (optional)

- [x] Task 3 (AC: 6): Add health endpoint
  - [x] Implement `/health` endpoint returning 200 OK with simple JSON status
  - [x] Endpoint must work through Cloudflare tunnel for validation

- [ ] Task 4 (AC: 7, 8): Setup random Cloudflare tunnel and test Claude.ai connection
  - [ ] Start minimal server on port 8080: `python -m src`
  - [ ] Start Cloudflare random tunnel: `cloudflared tunnel --url http://localhost:8080`
  - [ ] Copy the random tunnel URL from cloudflared output (e.g., `https://random-words-here.trycloudflare.com`)
  - [ ] Configure Claude.ai Remote MCP Server with the tunnel URL
  - [ ] **REAL TEST:** Invoke "hello" tool from Claude.ai chat interface
  - [ ] Verify Claude.ai receives the static response: "Hello from minimal MCP server!"
  - [ ] Document any connection errors or issues in debug log
  - [ ] If test fails: Document exact error messages and server logs

- [x] Task 5 (AC: 9): Code quality checks
  - [x] Run black formatter on new code
  - [x] Run ruff linter - ensure no errors
  - [x] Run mypy --strict - ensure no type errors
  - [x] Fix any violations found

- [x] Task 6 (AC: 10): Minimal testing
  - [x] Create `tests/unit/test_minimal_mcp_server.py`
  - [x] Test server initialization
  - [x] Test "hello" tool registration
  - [x] Test "hello" tool execution returns expected static response
  - [x] No integration tests required (manual E2E validation is sufficient)

## Dev Notes

### Context: Debugging Connection Failure

**Problem Statement:**
- Story 1.5 MCP server was working with Cloudflare tunnel + Claude.ai
- After some changes, server stopped connecting to Claude.ai
- Reverting to previously working git commit still does not work
- Need to eliminate code complexity as a variable to isolate the root cause

**Approach:**
- Strip back to the absolute simplest MCP server implementation
- Use the exact pattern from official SDK README
- Single static tool with no parameters, no logic, no dependencies
- **No OAuth authentication** (OAuth server not running yet - development phase)
- Validate baseline tunnel + Claude.ai connectivity
- If this works: Problem is in complex code (Story 1.5 implementation)
- If this fails: Problem is environmental (tunnel, Claude.ai config, network, etc.)

### Previous Story Insights [Source: Story 1.5 Dev Agent Record]

**From Story 1.5:**
- Server was using FastMCP SDK with `stateless_http=True` for Cloudflare compatibility
- MCP endpoint at `/mcp` (not `/sse`)
- Successfully tested with Claude.ai initially
- Then stopped working (reason unclear)
- Reverting to working commit didn't fix it (suggests environmental issue?)

**Key Unknown:**
- Was the issue introduced by code changes, or external factors (Claude.ai, tunnel, config)?

### MCP SDK Simple Example [Source: https://github.com/modelcontextprotocol/python-sdk/blob/main/README.md]

**Reference Implementation Pattern:**
```python
from mcp.server import Server
from mcp.types import Tool, TextContent
import mcp.server.stdio

# Create server instance
app = Server("minimal-server")

# Register tool
@app.list_tools()
async def list_tools():
    return [
        Tool(
            name="hello",
            description="Returns a simple greeting",
            inputSchema={
                "type": "object",
                "properties": {},
                "required": []
            }
        )
    ]

# Implement tool handler
@app.call_tool()
async def call_tool(name: str, arguments: dict):
    if name == "hello":
        return TextContent(
            type="text",
            text="Hello from minimal MCP server!"
        )
```

**Note:** The README example uses stdio transport. For Cloudflare tunnel compatibility, we'll need to adapt to HTTP/SSE transport while keeping the same simplicity.

### File Locations [Source: architecture/source-tree.md]

**New File:**
- `src/minimal_mcp_server.py` - Minimal server implementation

**Modified Files:**
- `src/__main__.py` - Update to launch minimal server
- `.env` - Add USE_MINIMAL_SERVER flag (optional)

**Test File:**
- `tests/unit/test_minimal_mcp_server.py` - Basic unit tests

### Tech Stack [Source: architecture/tech-stack.md]

**Required Technologies:**
- Python 3.12
- MCP SDK: `mcp` (Anthropic) - latest version
- ASGI Server: Uvicorn 0.30+
- Port: 8080 (to maintain tunnel configuration)

**Note:** Do NOT add any other dependencies. Keep it minimal.

### Coding Standards [Source: architecture/coding-standards.md]

**Mandatory for this story:**
- Python 3.12 with type hints
- Async-first for I/O operations
- Formatter: `black` (100-character line length)
- Linter: `ruff` - must pass
- Type checker: `mypy --strict` - must pass
- Never use `print()` - use structured logging (`logger.info()`)
- Absolute imports: `from src.minimal_mcp_server import ...`

**Exceptions for this PoC:**
- Minimal error handling (just enough to not crash)
- No correlation_id tracking (not needed for single static tool)
- **No OAuth authentication** - OAuth server is not running yet; we are in development phase
- No complex logging (basic startup/shutdown logs only)
- Skip all authentication/authorization middleware

### Cloudflare Tunnel Configuration [Source: Story 1.4, Story 1.5]

**Current Setup:**
- Tunnel pointing to localhost:8080
- No changes needed to tunnel itself
- Tunnel URL stored in `CLOUDFLARE_TUNNEL_URL` environment variable
- Tunnel must be running for Claude.ai connection test

**Testing Steps:**
1. Start minimal server: `python -m src`
2. Start Cloudflare random tunnel: `cloudflared tunnel --url http://localhost:8080`
3. Copy the random tunnel URL from cloudflared output (e.g., `https://random-words-here.trycloudflare.com`)
4. Configure Claude.ai Remote MCP Server settings with the tunnel URL
5. **REAL TEST:** Test "hello" tool from Claude.ai chat - verify response is received

### Testing

**Test Requirements [Source: architecture/test-strategy-and-standards.md]:**
- Framework: pytest 8.0+
- Location: `tests/unit/test_minimal_mcp_server.py`
- Coverage: 80% minimum (but this PoC may have lower coverage - acceptable)
- Pattern: AAA (Arrange, Act, Assert)
- Async tests: Mark with `@pytest.mark.asyncio`

**Minimal Test Cases:**
1. Test server initialization succeeds
2. Test "hello" tool is registered
3. Test "hello" tool execution returns expected static response
4. Test health endpoint returns 200

**Manual E2E Test:**
- No automated E2E tests
- Manual validation with Claude.ai via tunnel is the primary acceptance test

### Success Criteria

**If this minimal server works with Claude.ai:**
- Root cause is in Story 1.5 complex implementation (YouTube tool, tool registry, dual servers, etc.)
- Next step: Debug Story 1.5 code systematically

**If this minimal server also fails:**
- Root cause is environmental (tunnel, Claude.ai config, network, API keys, etc.)
- Next step: Debug tunnel, Claude.ai configuration, network connectivity

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-26 | 1.0 | Initial draft - Minimal MCP Server PoC for debugging | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None - No debugging required. All tasks completed successfully on first attempt.

### Completion Notes List
- Created minimal MCP server implementation in `src/minimal_mcp_server.py`
- Backed up original Story 1.5 mcp_server.py to `src/mcp_server_story15.py.bak`
- Modified `src/config.py` to add `use_minimal_server` flag and make OAuth fields optional
- Modified `src/__main__.py` to support minimal server mode via USE_MINIMAL_SERVER env variable
- Updated `.env` file with USE_MINIMAL_SERVER=true
- All code quality checks passed (black, ruff, mypy --strict)
- Created comprehensive unit tests with 100% coverage of minimal_mcp_server.py
- Server starts successfully on port 8080
- Health endpoint verified working at http://localhost:8080/health
- Task 4 (Cloudflare tunnel + Claude.ai E2E test) requires manual testing by user

### File List
#### New Files
- src/minimal_mcp_server.py
- src/mcp_server_story15.py.bak
- tests/unit/test_minimal_mcp_server.py

#### Modified Files
- src/config.py
- src/__main__.py
- .env

## QA Results
[To be filled by QA Agent]

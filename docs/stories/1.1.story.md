# Story 1.1: Python Project Setup and MCP Server Bootstrap

## Status
done

## Story
**As a** developer,
**I want** a properly initialized Python project with MCP SDK integration,
**so that** I have a solid foundation for building the extensible MCP server.

## Acceptance Criteria
1. Python project structure created with standard layout (src/, tests/, docs/, etc.)
2. `pyproject.toml` or `requirements.txt` configured with:
   - Python 3.12+ specified
   - Official Anthropic MCP Python SDK (`mcp`)
   - `youtube-transcript-api`
   - Testing framework (pytest)
   - Logging libraries (structlog)
3. Basic MCP server application created that:
   - Initializes MCP server instance
   - Starts and listens on configurable port (default 8080)
   - Logs startup message with structured JSON format
4. HTTP health check endpoint (`/health`) implemented returning 200 OK with JSON status
5. Git repository initialized with `.gitignore` for Python projects
6. README.md created with project overview and setup instructions
7. Application can be started locally via `python -m src.main` (or similar entry point)
8. Successful manual test: Server starts, health endpoint returns 200

## Tasks / Subtasks
- [x] Task 1 (AC: 5): Initialize Git repository and create a standard Python `.gitignore` file.
- [x] Task 2 (AC: 1): Create the initial project directory structure.
  - [x] Create directories: `src`, `tests/unit`, `tests/integration`, `docs`.
- [x] Task 3 (AC: 2): Configure the project dependencies in `pyproject.toml`.
  - [x] Specify Python version `~3.12`.
  - [x] Add main dependencies: `mcp`, `youtube-transcript-api`, `uvicorn`, `structlog`, `pydantic-settings`.
  - [x] Add development dependencies: `pytest`, `pytest-asyncio`, `pytest-mock`, `black`, `ruff`, `mypy`, `pip-tools`.
- [x] Task 4 (AC: 3, 4): Implement the basic server in `src/server.py`.
  - [x] Use Starlette to create a minimal ASGI application.
  - [x] Add a route for the `/health` endpoint.
  - [x] Implement an on_startup event handler.
- [x] Task 5 (AC: 3): Implement configuration management in `src/config.py`.
  - [x] Use `pydantic-settings` to define a `Config` class.
  - [x] Load `APP_PORT` from environment variables, defaulting to 8080.
- [x] Task 6 (AC: 3): Implement structured logging in `src/utils/logging.py`.
  - [x] Configure `structlog` to output JSON to stdout.
  - [x] Ensure the startup log message is structured.
- [x] Task 7 (AC: 4): Implement the health check handler in `src/handlers/health.py`.
  - [x] Define a `HealthCheckResponse` Pydantic model.
  - [x] Create an `async def health_check()` handler.
  - [x] The handler must return a JSON response with `status: "healthy"`, the current `timestamp`, a `version` (e.g., "0.1.0"), and an empty `registered_tools` list.
- [x] Task 8 (AC: 7): Create the main application entry point in `src/__main__.py`.
  - [x] Import the application instance from `src/server.py` and the config from `src/config.py`.
  - [x] Use `uvicorn.run()` to start the server.
- [x] Task 9 (AC: 6): Create a `README.md` with a project overview and setup instructions.
- [x] Task 10 (AC: 4, 8): Create a unit test for the health check endpoint.
  - [x] Create file `tests/unit/test_health_handler.py`.
  - [x] Write an async test that uses an HTTP client (like `httpx`) to query the `/health` endpoint.
  - [x] Assert that the status code is 200 and the response body matches the `HealthCheckResponse` model.

## Dev Notes

### Previous Story Insights
- No previous story exists. This is the first story.

### Data Models
- A `HealthCheckResponse` model should be created, likely in `src/models/mcp.py` or a new `src/models/server.py`, with the following fields: `status: str`, `timestamp: datetime`, `version: str`, `registered_tools: list[str]`. [Source: `docs/architecture/data-models.md#HealthCheckResponse`]

### API Specifications
- The server must expose a `GET /health` endpoint that requires no authentication.
- It must return a 200 OK with a JSON body conforming to the `HealthCheckResponse` model. [Source: `docs/architecture/mcp-server-api-specification.md#get-health`]

### File Locations
- **`src/__main__.py`**: Main entry point to run the application.
- **`src/server.py`**: Contains the core ASGI (Starlette) application, routing, and startup events.
- **`src/config.py`**: Defines and loads configuration using `pydantic-settings`.
- **`src/handlers/health.py`**: Contains the logic for the `/health` endpoint.
- **`src/utils/logging.py`**: Handles `structlog` configuration.
- **`tests/unit/test_health_handler.py`**: Unit test for the health handler.
- [Source: `docs/architecture/source-tree.md`]

### Technical Constraints
- **Python Version**: Must be 3.12+.
- **Logging**: All logging must use `structlog` for structured JSON output. `print()` is forbidden.
- **Imports**: All imports must be absolute (e.g., `from src.config import get_config`).
- [Source: `docs/architecture/tech-stack.md`, `docs/architecture/coding-standards.md`]

## Testing
- Unit tests are required for all new functionality and must be placed in `tests/unit/`.
- Test files must be named `test_{module_name}.py`.
- Asynchronous tests require `@pytest.mark.asyncio`.
- A unit test for the `/health` endpoint is mandatory for this story to verify the endpoint is working correctly.
- [Source: `docs/architecture/test-strategy-and-standards.md`]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-22 | 1.0 | Initial draft | Bob (Scrum Master) |
| 2025-11-22 | 1.1 | Implemented QA feedback: Added unit tests for `src/config.py` and `src/utils/logging.py`. Fixed various linting issues and resolved `pytest` errors related to environment variables, `structlog` configuration, and logger type assertions. | James (Full Stack Developer) |

## Dev Agent Record
### Agent Model Used
Gemini 1.5 Flash

### Debug Log References
- All shell commands executed during development.

### Completion Notes List
- The story involved setting up a Python project with a FastAPI server and a health check endpoint.
- Most initial files and directories were missing, requiring their creation.
- Addressed `pyproject.toml` dependencies and FastAPI integration.
- Implemented structured logging with `structlog`.
- Created placeholder implementations for `ToolRegistry`, `BaseMCPTool`, `YouTubeTool`, and `oauth_middleware` to satisfy imports and allow server startup.
- Fixed `APP_PORT` default value in `src/config.py`.
- Developed a unit test for the `/health` endpoint.
- Resolved various linting (`ruff`) and type-checking (`mypy`) issues.
- Ensured all checks (`pytest`, `ruff`, `mypy`) pass.
- Added new unit tests for `src/config.py` (`tests/unit/test_config.py`) to verify default values, environment variable overrides, and missing required fields.
- Added new unit tests for `src/utils/logging.py` (`tests/unit/test_logging.py`) to verify structlog configuration and logger instance retrieval.
- Resolved `ImportError` for `MCPToolInvocation` and `MCPToolResponse` by removing incorrect imports from `src/models/__init__.py`.
- Fixed `ruff` linting issues (undefined `Callable`, unused imports, no newline at end of file, import block formatting).
- Corrected `pytest` failures in `tests/unit/test_config.py` by ensuring proper environment variable isolation (`_env_file=None` and `monkeypatch.delenv`) and `lru_cache` clearing.
- Corrected `pytest` failures in `tests/unit/test_logging.py` by fixing `AttributeError` for `getLevelName()` and `AssertionError` for `isinstance()` by asserting against `BoundLogger` after `.bind()`.

### File List
**Created Files:**
- `.env`
- `README.md`
- `src/handlers/__init__.py`
- `src/handlers/health.py`
- `src/middleware/__init__.py`
- `src/middleware/oauth.py`
- `src/registry/__init__.py`
- `src/registry/tool_registry.py`
- `src/tools/__init__.py`
- `src/tools/base.py`
- `src/tools/youtube_tool.py`
- `src/utils/__init__.py`
- `src/utils/logging.py`
- `tests/unit/test_health_handler.py`
- `tests/unit/test_config.py`
- `tests/unit/test_logging.py`

**Modified Files:**
- `pyproject.toml`
- `src/config.py`
- `src/models/auth.py`
- `src/models/__init__.py` (removed incorrect imports)
- `src/middleware/oauth.py` (fixed Callable import, removed commented code)
- `src/utils/logging.py` (cleaned newlines, corrected ProcessorFormatter arguments)
- `tests/unit/test_config.py` (improved test isolation for environment variables)
- `tests/unit/test_logging.py` (fixed level name assertion and logger type assertion)

## QA Results

### Review Date: 2025-11-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall, the implementation demonstrates a strong foundation with good adherence to modern Python practices. The use of `pydantic-settings`, `structlog`, and FastAPI for server setup are excellent choices. The `ToolRegistry` pattern sets a good precedent for extensibility. Type hinting is consistently applied.

### Refactoring Performed

-   **File**: `src/models/mcp.py` (created)
    -   **Change**: Created `src/models/mcp.py` to define the `HealthCheckResponse` Pydantic model.
    -   **Why**: To ensure the `HealthCheckResponse` model accurately reflects all fields returned by the `/health` endpoint, including `timestamp` and `registered_tools`, as per story requirements and to maintain data model consistency. This file was implicitly required by `src/handlers/health.py` but not explicitly listed as created.
    -   **How**: Defined a Pydantic `BaseModel` with `status`, `version`, `timestamp`, `tools_loaded`, and `registered_tools` fields.
-   **File**: `src/handlers/health.py` (modified)
    -   **Change**: Modified the `health_check` function to directly populate the `HealthCheckResponse` model with `datetime.now(UTC)` for `timestamp` and actual tool names for `registered_tools`. Removed manual dictionary manipulation.
    -   **Why**: To align the implementation with the refined `HealthCheckResponse` model and leverage Pydantic's serialization directly, improving type safety and maintainability.
    -   **How**: Updated the `HealthCheckResponse` instantiation and replaced `response_data["timestamp"] = ...` and `response_data["registered_tools"] = []` with direct model field assignment, then returned `response_model.model_dump(mode="json")`.
-   **File**: `src/middleware/oauth.py` (modified)
    -   **Change**: Removed extensive commented-out OAuth implementation code and replaced the general pass-through for non-health endpoints with an `HTTPException(501, detail="OAuth2 authentication not implemented")`.
    -   **Why**: To clarify the placeholder status of the OAuth middleware, prevent unintended security risks by explicitly blocking unauthenticated access to non-health endpoints where authentication is expected, and improve code readability by removing commented-out logic.
    -   **How**: Replaced the `pass` logic and commented code with an explicit `raise HTTPException`.

### Compliance Check

-   Coding Standards: ✓ (Good adherence to Python 3.12, type hints, async-first, `black`/`ruff`/`mypy` configurations, `structlog`, absolute imports. Some foundational tests are missing but not mandated by the story.)
-   Project Structure: ✓ (Standard Python project layout, clear separation of concerns.)
-   Testing Strategy: ✓ (Unit test for `/health` adheres to naming, location, and async testing standards.)
-   All ACs Met: ✓ (All 8 Acceptance Criteria are addressed by the implementation, including the refactored portions.)

### Improvements Checklist

-   [x] Refactored `HealthCheckResponse` model definition and usage for consistency.
-   [x] Clarified OAuth middleware placeholder with explicit `HTTPException`.
-   [x] **Consider adding unit tests for `src/config.py` to ensure proper loading and validation of environment variables and default values.** (Suggested owner: dev)
-   [x] **Consider adding unit tests for `src/utils/logging.py` to verify `structlog` configuration and structured output.** (Suggested owner: dev)
-   [ ] **Plan for the full implementation of the OAuth middleware (`src/middleware/oauth.py`) in an upcoming story, defining its full scope and security requirements.** (Suggested owner: sm, po)

### Security Review

The initial `oauth_middleware` in `src/middleware/oauth.py` was a significant security concern due to its pass-through nature. The refactoring addresses this by explicitly raising a `501 Not Implemented` error, preventing unintended access to unauthenticated endpoints. However, the OAuth implementation itself remains incomplete and is a critical next step. `config.py` correctly uses `pydantic-settings` for secure loading of OAuth configuration from environment variables.

### Performance Considerations

The implemented components are lightweight and leverage performant libraries (FastAPI, Uvicorn). No immediate performance concerns for this bootstrap story.

### Files Modified During Review

-   `src/models/mcp.py` (created)
-   `src/handlers/health.py`
-   `src/middleware/oauth.py`

### Gate Status

Gate: CONCERNS → `docs/qa/gates/1.1-python-project-setup-and-mcp-server-bootstrap.yml`
Risk profile: Not generated as a separate artifact for this review, but embedded in the analysis.
NFR assessment: Not generated as a separate artifact for this review, but embedded in the analysis.

### Recommended Status

✓ Ready for Done, with noted concerns to be addressed in future stories or follow-up tasks. The identified improvements (especially OAuth implementation and core component testing) should be prioritized.
